# Magic: The Gathering style card set
# Demonstrates dynamic asset generation and compound assets

name: "Shadows of Valdris"
version: "1.0"
description: |
  A 50-card Magic-style set with gothic horror themes.
  Includes new mechanics decided during generation.
  
  This pipeline demonstrates:
  - Type definitions for structured assets
  - Research steps that inform later generation
  - Dynamic asset creation (cards defined by a step)
  - Conditional steps based on rarity
  - Gather operations for final compilation

# =============================================================================
# Type Definitions
# =============================================================================

types:
  MagicCard:
    # Identity
    name: text
    id: text
    
    # Game mechanics
    mana_cost: text
    colors: list
    type_line: text
    abilities: text
    power: number?              # Only for creatures
    toughness: number?
    
    # Creative content
    flavor_text: text?
    art_prompt: text?
    art: image?                 # Generated by pipeline
    
    # Metadata
    rarity: common | uncommon | rare | mythic
    set_number: number?

# =============================================================================
# Context
# =============================================================================

context:
  setting: "Gothic horror, crumbling cathedrals, haunted forests"
  card_count: 50
  distribution:
    common: 25
    uncommon: 15
    rare: 8
    mythic: 2

# =============================================================================
# Assets
# =============================================================================

assets:
  type: MagicCard
  generated_by: design_cards  # Cards created by step below

steps:
  # ===================
  # Phase 1: Set Design
  # ===================
  
  # Research existing MTG design (runs independently)
  - id: research_mtg
    type: research
    config:
      query: |
        Magic: The Gathering set design:
        - Recent keyword mechanics (2020-2024)
        - Gothic horror themed cards
        - Balanced mana curves
        - Rarity distribution best practices

  # Research art styles (runs in parallel with above)
  - id: research_art
    type: research
    config:
      query: |
        Magic: The Gathering card art:
        - Dark fantasy illustration styles
        - Composition within card frame
        - Color palettes for gothic horror

  # Brainstorm new mechanics (needs research)
  - id: brainstorm_mechanics
    type: generate_text
    requires: [research_mtg]
    config:
      prompt: |
        Based on MTG research: {research_mtg.output}
        
        Brainstorm 8 new keyword mechanics for a gothic horror set.
        For each mechanic provide:
        1. Name (single evocative word)
        2. Rules text template
        3. Flavor explanation
        4. Which colors (WUBRG) it appears in
        5. Rarity restriction if any
        
        Be creative but balanced.
      variations: 2

  # User picks mechanics to use
  - id: select_mechanics
    type: user_select
    requires: [brainstorm_mechanics]
    config:
      prompt: "Select 3-4 mechanics for the set"
      min_selections: 3
      max_selections: 4

  # Create style guide (needs art research)
  - id: style_guide
    type: generate_text
    requires: [research_art]
    config:
      prompt: |
        Based on art research: {research_art.output}
        
        Create an art direction guide for this gothic horror card set:
        - Color palette (specific hex codes)
        - Lighting style
        - Composition guidelines
        - What to avoid
        - Reference artists/works

  # Design the card list (needs mechanics selected)
  - id: design_cards
    type: generate_text
    requires: [select_mechanics]
    config:
      prompt: |
        Design {context.card_count} cards for a gothic horror Magic set.
        
        Selected mechanics: {select_mechanics.output}
        
        Distribution:
        - {context.distribution.common} common
        - {context.distribution.uncommon} uncommon
        - {context.distribution.rare} rare
        - {context.distribution.mythic} mythic
        
        For each card output YAML with:
        - id: unique identifier
        - name: card name
        - rarity: common/uncommon/rare/mythic
        - colors: list of W/U/B/R/G
        - type: creature/instant/sorcery/enchantment/artifact
        
        Ensure good color balance and mana curve.
      output_format: yaml

  # ========================
  # Phase 2: Per-Card Steps
  # ========================
  
  # Generate abilities for each card
  - id: card_abilities
    type: generate_text
    for_each: asset
    requires: [design_cards, select_mechanics]
    config:
      prompt: |
        Write abilities for: {asset.name}
        Type: {asset.type}, Rarity: {asset.rarity}
        Colors: {asset.colors}
        
        Available mechanics: {select_mechanics.output}
        
        Match complexity and power to rarity level.
        Use at most one keyword mechanic per card.

  # Generate flavor text
  - id: card_flavor
    type: generate_text
    for_each: asset
    requires: [card_abilities]
    config:
      prompt: |
        Write flavor text for: {asset.name}
        Abilities: {card_abilities.output}
        Setting: {context.setting}
        
        Max 2 sentences. Evocative, mysterious, dark.
        Should complement but not explain the abilities.
      max_length: 150

  # Create art prompt
  - id: art_prompt
    type: generate_prompt
    for_each: asset
    requires: [card_flavor, style_guide]
    config:
      prompt: |
        Create an art prompt for Magic card: {asset.name}
        Type: {asset.type}
        Flavor: {card_flavor.output}
        Style guide: {style_guide.output}
        
        The prompt should describe a single dramatic scene.
        Include lighting, composition, mood.

  # Generate card art
  - id: card_art
    type: generate_image
    for_each: asset
    requires: [art_prompt]
    config:
      prompt: "{art_prompt.output}"
      # More variations for rarer cards
      variations: "4 if asset.rarity in ['rare', 'mythic'] else 2"
      size: 1024
      aspect_ratio: "4:3"

  # AI assessment of art quality
  - id: assess_art
    type: assess
    for_each: asset
    requires: [card_art]
    config:
      criteria:
        - "Matches the card name and concept"
        - "Fits gothic horror aesthetic"
        - "Good composition for card frame (subject centered)"
        - "No text, watermarks, or artifacts"
        - "Dramatic lighting present"
      threshold: 0.7
      on_fail: retry
      max_retries: 2

  # Human approval for rare/mythic only
  - id: approve_art
    type: user_approve
    for_each: asset
    requires: [assess_art]
    condition: "asset.rarity in ['rare', 'mythic']"
    config:
      prompt: |
        Approve art for {asset.name} ({asset.rarity})?
        
        This is a {asset.rarity} card - quality matters!

  # ====================
  # Phase 3: Compilation
  # ====================
  
  # Wait for ALL cards, then compile
  - id: compile_set
    type: custom
    gather: true
    requires: [approve_art, card_abilities, card_flavor]
    config:
      function: compile_card_set
      output:
        - set.json         # Full set data
        - cards/           # Individual card images
        - print_sheets/    # Print-ready layouts
